<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
</head>
<body>
    <form name="absenceForm">
        <input name="id" type="hidden" value="0" />
        <div class="form-group col-md-5">
            <label for="validationDefault01">Причина отсутствия:</label>
            <select class="form-select" name="reason" id="validationDefault01" aria-label="Default select example" required>
                <option value="0">Отпуск</option>
                <option value="1">Больничный</option>
                <option value="2">Прогул</option>
            </select>
            <div class="valid-feedback">
                Все хорошо!
            </div>
            <div class="invalid-feedback">
                Это поле обязательно
            </div>
        </div>
        <div class="form-group col-md-5">
            <label for="age">Дата начала:</label>
            <input class="form-control" name="startDate" id="validationDefault02" type="date" required/>
            <div class="valid-feedback">
                Все хорошо!
            </div>
            <div class="invalid-feedback">
                Это поле обязательно
            </div>
        </div>
        <div class="form-group col-md-5">
            <label for="name">Продолжительность отсутствия:</label>
            <input class="form-control" name="duration" id="validationDefault03" type="number" required/>
            <div class="valid-feedback">
                Все хорошо!
            </div>
            <div class="invalid-feedback">
                Это поле обязательно
            </div>
        </div>
        <div class="form-group col-md-5">
            <label for="age">Учтено при оплате</label>
            <input class="form-check-input" type="checkbox" value="true"
                   name="discounted" id="validationDefault04" />
            <div class="valid-feedback">
                Все хорошо!
            </div>
            <div class="invalid-feedback">
                Это поле обязательно
            </div>
        </div>
        <div class="form-group col-md-5">
            <label for="age">Комментарий человека:</label>
            <input class="form-control" name="description" id="validationDefault05" type="text" required/>
            <div class="valid-feedback">
                Все хорошо!
            </div>
            <div class="invalid-feedback">
                Это поле обязательно
            </div>
        </div>
        <div class="panel-body">
            <button type="submit" id="submit" class="btn btn-primary">Сохранить</button>
            <a id="reset" class="btn btn-primary">Сбросить</a>
        </div>
    </form>
    <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Причина отсутствия</th>
                <th>Дата начала</th>
                <th>Продолжительность отсутствия</th>
                <th>Oтсутствие учтено?</th>
                <th>Комментарий человека</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            </tr>
        </tbody>
    </table>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="lib/jquery/dist/jquery.min.js"></script>
   
    <script language="javascript" type="text/javascript">
        async function GetUsers() {
            let response = await fetch("/api/Values", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok) {
                let result = await response.json();
                let rows = document.querySelector('tbody');
                result.forEach(form => {
                    rows.append(row(form))
                });
            } else {
                alert("Error:" + response.status)
            }
        }
        async function GetUser(id) {
            const response = await fetch("/api/Values/" + id, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok) {
                let result = await response.json();
                let form = document.forms["absenceForm"];
                form.elements["id"].value = result.id;
                form.elements["reason"].value = result.reason;
                form.elements["startDate"].value = "0001-01-01";
                form.elements["duration"].value = result.duration;
                form.elements["discounted"].value = result.discounted;
                form.elements["description"].value = result.description;
            } else {
                console.log("Error:" + response.status)
            }
        }
        async function DeleteFormAbsence(id) {
            const response = await fetch("/api/Values/" + id, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok) {
                let result = await response.json();
                document.querySelector("tr[data-rowid='" + result.id + "']").remove();
            } else {
                console.log("Error:" + response.status)
            }
        }


        async function EditFormAbsecne(Fid, Freason, FstartDate, Fduration, Fdiscounted, Fdescription) {
            const response = await fetch("/api/Values" + id,
                {
                    method: "PUT",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: parseInt(Fid, 10),
                        reason: parseInt(Freason, 10),
                        startDate: FstartDate,
                        duration: Fduration,
                        discounted: Fdiscounted,
                        description: Fdescription
                    })
                });
            if (response.ok) {
                let result = await response.json();
                document.querySelector("tr[data-rowid='" + result.id + "']").replaceWith(row(result));
                reset();
                console.log("форма изменена");
            } else {
                console.log("Error:" + response.status);
            }
        }

            async function CreateFormAbsence(Freason, FstartDate, Fduration, Fdiscounted, Fdescription) {
                const response = await fetch("/api/Values", {
                    method: "POST",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        reason: parseInt(Freason, 10),
                        startDate: FstartDate,
                        duration: Fduration,
                        discounted: Fdiscounted,
                        description: Fdescription
                    })
                });
                if (response.ok) {
                    let result = await response.json();
                    document.querySelector("tbody").append(row(result));
                    reset();
                    console.log("создана новая форма");
                } else {
                    console.log("Error:" + response.status)
                }
            }

        function row(form) {
            let tr = document.createElement('tr');
            tr.setAttribute("data-rowid", form.id);

            let idTd = document.createElement("td");
            idTd.append(form.id);
            tr.append(idTd);

            let reasonTd = document.createElement("td");
            reasonTd.append(form.reason);
            tr.append(reasonTd);
            
            let startDateId = document.createElement("td");
            startDateId.append(form.startDate);
            tr.append(startDateId);

            let durationId = document.createElement("td");
            durationId.append(form.duration)
            tr.append(durationId);

            let discountedId = document.createElement("td");
            discountedId.append(form.discounted);
            tr.append(discountedId);

            let descriptionId = document.createElement("td");
            descriptionId.append(form.description);
            tr.append(descriptionId);

            let editTd = document.createElement("td");

            let editLink = document.createElement("button");
            editLink.setAttribute("data-id", form.id);
            editLink.append("Изменить");
            editLink.className += "btn btn-primary";
            editLink.addEventListener("click", e => {
                e.preventDefault();
                GetUser(form.id);
            });
            editTd.append(editLink);

            let removeTd = document.createElement("td");

            let removeLink = document.createElement("button");
            removeLink.setAttribute("data-id", form.id);
            removeLink.className += "btn btn-danger";
            removeLink.append("Удалить");
            removeLink.addEventListener("click", e => {
                console.log("Удалил");
                e.preventDefault();
                DeleteFormAbsence(form.id);
            });
            removeTd.append(removeLink);

            tr.append(editTd);
            tr.append(removeTd);
            return tr;
        }
        function reset() {
            const form = document.forms["absenceForm"];
            form.reset();
            form.elements["id"].value = 0;
        };
        document.getElementById("reset").addEventListener("click", e => {
            e.preventDefault();
            reset();
        });
        document.forms["absenceForm"].addEventListener("submit", e => {
            e.preventDefault();
            form = document.forms["absenceForm"];
            //let id = form.elements["id"].value;
            //let reason = form.elements["reason"].value;
            //let startDate = form.elements["startDate"].value;
            //let duration = form.elements["duration"].value;

            //let discounted = form.elements["discounted"].value;
            //var discounted = form.elements["discounted"].value == "on" ? 'true' : 'false';

            //let description = form.elements["description"].value;

            let id = form.elements["id"].value;
            let reason = form.elements["reason"].value;
            let startDate = form.elements["startDate"].value;
            let duration = 3;
            let discounted = false;
            let description = "kakasi";
            if (id == 0) {
                CreateFormAbsence(reason, startDate, duration, discounted, description)
            } else {
                EditFormAbsecne(id, reason, startDate, duration, discounted, description);
            }
        });
        
            

        GetUsers();
            async function rowForSingle() {

                let response = await fetch("/api/Values", {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok) {
                    let result = await response.json();
                    let s = result[result.length - 1];
                    return s.id + 1;
                }
            }

    </script>
</body>
</html>